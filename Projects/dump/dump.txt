public class CorrelationIdSession implements CqlSession {

    private final CqlSession delegate;
    private final Supplier<String> correlationIdSupplier;

    public CorrelationIdSession(CqlSession delegate, Supplier<String> supplier) {
        this.delegate = delegate;
        this.correlationIdSupplier = supplier;
    }

    @Override
    public ResultSet execute(Statement<?> statement) {
        return delegate.execute(withCorrelationId(statement));
    }

    @Override
    public CompletionStage<AsyncResultSet> executeAsync(Statement<?> statement) {
        return delegate.executeAsync(withCorrelationId(statement));
    }

    private <T extends Statement<?>> T withCorrelationId(T stmt) {
        String corrId = correlationIdSupplier.get();
        if (corrId != null) {
            return (T) stmt.setCustomPayload(
                Map.of("correlation-id",
                    ByteBuffer.wrap(corrId.getBytes(StandardCharsets.UTF_8)))
            );
        }
        return stmt;
    }

    // delegate all other methods to `delegate`
}